#!/bin/bash
# launch-webapp - Launch a URL as a standalone web app window
# Usage: launch-webapp [--floating] <url>

floating=false
if [[ "$1" == "--floating" ]]; then
    floating=true
    shift
fi

if [[ -z "$1" ]]; then
    echo "Usage: launch-webapp [--floating] <url>"
    exit 1
fi

browser=$(xdg-settings get default-web-browser 2>/dev/null)

# Only Chromium-based browsers support --app flag
# Match both native package names and Flatpak app IDs
browser_lower="${browser,,}"
is_chromium=false

case "$browser_lower" in
*chrome* | *chromium* | *brave* | *edge* | *opera* | *vivaldi* | *thorium* | *arc*)
    is_chromium=true
    ;;
esac

if [[ "$is_chromium" != "true" ]]; then
    browser="chromium.desktop"
fi

# Search paths for .desktop files (including Flatpak)
search_paths=(
    "$HOME/.local/share/applications/$browser"
    "$HOME/.local/share/flatpak/exports/share/applications/$browser"
    "$HOME/.nix-profile/share/applications/$browser"
    "/var/lib/flatpak/exports/share/applications/$browser"
    "/usr/share/applications/$browser"
)

# Find the .desktop file
desktop_file=""
for path in "${search_paths[@]}"; do
    if [[ -f "$path" ]]; then
        desktop_file="$path"
        break
    fi
done

if [[ -z "$desktop_file" ]]; then
    echo "Could not find desktop file for $browser"
    exit 1
fi

# Check if it's a Flatpak app
if grep -q "^Exec=.*flatpak run" "$desktop_file"; then
    # Extract Flatpak app ID (e.g., com.microsoft.Edge, com.google.Chrome)
    app_id=$(grep "^Exec=" "$desktop_file" | head -1 | sed -n 's/.*flatpak run .* \(com\.[a-zA-Z0-9._-]*\|org\.[a-zA-Z0-9._-]*\|io\.[a-zA-Z0-9._-]*\).*/\1/p')
    if [[ -z "$app_id" ]]; then
        # Fallback: use desktop file basename
        app_id=$(basename "$desktop_file" .desktop)
    fi
    setsid flatpak run "$app_id" --app="$1" &>/dev/null &
else
    # Native app - extract executable
    browser_exec=$(sed -n 's/^Exec=\([^ ]*\).*/\1/p' "$desktop_file" | head -1)
    if [[ -z "$browser_exec" ]]; then
        echo "Could not find browser executable in $desktop_file"
        exit 1
    fi
    setsid "$browser_exec" --app="$1" &>/dev/null &
fi

# If floating mode requested, wait for window and toggle floating + center
if [[ "$floating" == "true" ]]; then
    sleep 0.5
    hyprctl dispatch togglefloating &>/dev/null
    hyprctl dispatch centerwindow &>/dev/null
fi
